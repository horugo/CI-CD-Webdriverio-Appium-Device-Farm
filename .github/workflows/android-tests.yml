name: Android Automation Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout do código
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '24'
        cache: 'npm'

    - name: Instalar dependências
      run: npm ci

    - name: Setup Java
      uses: actions/setup-java@v3
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v2  # ✅ Versão correta

    - name: Instalar Android Command Line Tools
      run: |
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
        mkdir -p $ANDROID_HOME/cmdline-tools
        unzip -q commandlinetools-linux-9477386_latest.zip -d $ANDROID_HOME/cmdline-tools
        mv $ANDROID_HOME/cmdline-tools/cmdline-tools $ANDROID_HOME/cmdline-tools/latest

    - name: Aceitar licenças Android
      run: |
        yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses

    - name: Instalar Android 10 e emulador
      run: |
        $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "platforms;android-29" "system-images;android-29;google_apis;x86_64" "emulator" "platform-tools"

    - name: Criar AVD
      run: |
        echo "no" | $ANDROID_HOME/cmdline-tools/latest/bin/avdmanager create avd -n test_avd -k "system-images;android-29;google_apis;x86_64" -d "pixel_4"

    - name: Iniciar emulador
      run: |
        $ANDROID_HOME/emulator/emulator -avd test_avd -no-window -no-audio -no-snapshot -gpu swiftshader_indirect &
        sleep 30

    - name: Aguardar emulador ficar pronto
      run: |
        adb wait-for-device
        while [ "`adb shell getprop sys.boot_completed | tr -d '\r' `" != "1" ]; do
          sleep 5
          echo "⏳ Aguardando emulador..."
        done
        echo "✅ Emulador pronto!"

    - name: Verificar emulador
      run: |
        adb devices
        adb shell getprop ro.build.version.release
        adb shell getprop ro.product.model

    - name: Instalar e iniciar Appium
      run: |
        npm install -g appium
        appium --log-level info --session-override --allow-insecure chromedriver_autodownload &
        sleep 10

    - name: Verificar se app existe
      run: |
        if [ -f "app/android/flutter.apk" ]; then
          echo "✅ App encontrado!"
          ls -la app/android/flutter.apk
        else
          echo "❌ App NÃO encontrado!"
          find . -name "*.apk" || echo "Nenhum APK encontrado"
          exit 1
        fi

    - name: Executar testes WebdriverIO
      run: npm run wdio
      timeout-minutes: 30
