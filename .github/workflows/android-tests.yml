name: Android Tests - AWS Device Farm

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout do c√≥digo
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '24'
        cache: 'npm'

    - name: Configurar AWS CLI
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1

    - name: Instalar depend√™ncias AWS
      run: |
        # Instalar AWS CLI se necess√°rio
        curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
        unzip awscliv2.zip
        sudo ./aws/install
        aws --version

    - name: Verificar se APK existe
      run: |
        if [ -f "app/android/flutter.apk" ]; then
          echo "‚úÖ APK encontrado"
          ls -la app/android/flutter.apk
        else
          echo "‚ùå APK n√£o encontrado"
          exit 1
        fi

    - name: Upload APK para S3
      run: |
        TIMESTAMP=$(date +%Y%m%d%H%M%S)
        aws s3 cp app/android/flutter.apk s3://${{ secrets.AWS_S3_BUCKET }}/apps/flutter-app-$TIMESTAMP.apk
        echo "APP_S3_URL=s3://${{ secrets.AWS_S3_BUCKET }}/apps/flutter-app-$TIMESTAMP.apk" >> $GITHUB_ENV

    - name: Criar projeto no Device Farm
      run: |
        # Verificar se projeto j√° existe
        PROJECT_EXISTS=$(aws devicefarm list-projects --query "projects[?name=='MeuProjetoTeste']" --output text)
        
        if [ -z "$PROJECT_EXISTS" ]; then
          echo "Criando novo projeto..."
          aws devicefarm create-project --name "MeuProjetoTeste"
        else
          echo "Projeto j√° existe"
        fi

    - name: Executar testes no Device Farm
      run: |
        # Obter ARN do projeto
        PROJECT_ARN=$(aws devicefarm list-projects --query "projects[?name=='MeuProjetoTeste'].arn" --output text)
        
        # Obter ARN do device pool padr√£o
        DEVICE_POOL_ARN=$(aws devicefarm list-device-pools --arn $PROJECT_ARN --query "devicePools[?name=='Top Devices'].arn" --output text)
        
        # Upload do APK para Device Farm
        UPLOAD_APP_RESPONSE=$(aws devicefarm create-upload \
          --project-arn $PROJECT_ARN \
          --name "flutter-app-$TIMESTAMP.apk" \
          --type ANDROID_APP \
          --content-type application/vnd.android.package-archive)
        
        APP_UPLOAD_ARN=$(echo $UPLOAD_APP_RESPONSE | jq -r '.upload.arn')
        APP_UPLOAD_URL=$(echo $UPLOAD_APP_RESPONSE | jq -r '.upload.url')
        
        # Fazer upload do APK
        curl -T app/android/flutter.apk "$APP_UPLOAD_URL"
        
        # Aguardar upload ser processado
        echo "Aguardando processamento do APK..."
        while true; do
          STATUS=$(aws devicefarm get-upload --arn $APP_UPLOAD_ARN --query 'upload.status' --output text)
          echo "Status do upload: $STATUS"
          if [ "$STATUS" == "SUCCEEDED" ]; then
            break
          elif [ "$STATUS" == "FAILED" ]; then
            echo "‚ùå Upload falhou"
            exit 1
          fi
          sleep 10
        done

        # Upload do teste Appium (se tiver)
        UPLOAD_TEST_RESPONSE=$(aws devicefarm create-upload \
          --project-arn $PROJECT_ARN \
          --name "appium-tests.zip" \
          --type APPIUM_JAVA_TESTNG_TEST_PACKAGE \
          --content-type application/zip)
        
        TEST_UPLOAD_ARN=$(echo $UPLOAD_TEST_RESPONSE | jq -r '.upload.arn')
        TEST_UPLOAD_URL=$(echo $UPLOAD_TEST_RESPONSE | jq -r '.upload.url')
        
        # Criar arquivo de teste vazio (substitua pelo seu depois)
        zip -r appium-tests.zip ./tests/ || echo "Criando teste vazio..." && touch empty.txt && zip appium-tests.zip empty.txt
        
        curl -T appium-tests.zip "$TEST_UPLOAD_URL"
        
        # Aguardar upload do teste
        while true; do
          STATUS=$(aws devicefarm get-upload --arn $TEST_UPLOAD_ARN --query 'upload.status' --output text)
          echo "Status do upload do teste: $STATUS"
          if [ "$STATUS" == "SUCCEEDED" ]; then
            break
          elif [ "$STATUS" == "FAILED" ]; then
            echo "‚ùå Upload do teste falhou"
            break
          fi
          sleep 10
        done

        # Agendar execu√ß√£o
        echo "Agendando execu√ß√£o no Device Farm..."
        SCHEDULE_RUN_RESPONSE=$(aws devicefarm schedule-run \
          --project-arn $PROJECT_ARN \
          --app-arn $APP_UPLOAD_ARN \
          --device-pool-arn $DEVICE_POOL_ARN \
          --name "Run-$TIMESTAMP" \
          --test type=APPIUM_JAVA_TESTNG,testPackageArn=$TEST_UPLOAD_ARN)
        
        RUN_ARN=$(echo $SCHEDULE_RUN_RESPONSE | jq -r '.run.arn')
        echo "RUN_ARN=$RUN_ARN" >> $GITHUB_ENV

    - name: Aguardar conclus√£o dos testes
      run: |
        echo "‚è≥ Aguardando execu√ß√£o no Device Farm..."
        while true; do
          RUN_STATUS=$(aws devicefarm get-run --arn $RUN_ARN --query 'run.status' --output text)
          echo "Status da execu√ß√£o: $RUN_STATUS"
          
          case $RUN_STATUS in
            "COMPLETED")
              echo "‚úÖ Execu√ß√£o completada"
              break
              ;;
            "ERRORED"|"STOPPED")
              echo "‚ùå Execu√ß√£o falhou: $RUN_STATUS"
              exit 1
              ;;
            "PENDING"|"PROCESSING"|"SCHEDULING"|"RUNNING"|"RESTARTING")
              sleep 30
              ;;
            *)
              echo "Status desconhecido: $RUN_STATUS"
              sleep 30
              ;;
          esac
        done

    - name: Obter resultados
      run: |
        # Obter resultados detalhados
        aws devicefarm get-run --arn $RUN_ARN > run-details.json
        cat run-details.json
        
        # Contar testes passados/falhados
        PASSED=$(cat run-details.json | jq '.run.resultCounts.passed // 0')
        FAILED=$(cat run-details.json | jq '.run.resultCounts.failed // 0')
        WARNED=$(cat run-details.json | jq '.run.resultCounts.warned // 0')
        SKIPPED=$(cat run-details.json | jq '.run.resultCounts.skipped // 0')
        
        echo "üìä RESULTADOS:"
        echo "‚úÖ Passados: $PASSED"
        echo "‚ùå Falhados: $FAILED"
        echo "‚ö†Ô∏è  Avisos: $WARNED"
        echo "‚è≠Ô∏è  Pulados: $SKIPPED"
        
        # Falhar o workflow se houver testes falhados
        if [ $FAILED -gt 0 ]; then
          echo "‚ùå Testes falharam!"
          exit 1
        fi
