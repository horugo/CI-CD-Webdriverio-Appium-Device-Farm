name: AWS Device Farm - Google Pixel 9

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout do c√≥digo
      uses: actions/checkout@v4

    - name: Setup Node.js 24
      uses: actions/setup-node@v4
      with:
        node-version: '24'
        cache: 'npm'

    - name: Setup Java 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Instalar depend√™ncias
      run: npm ci

    - name: Configurar AWS
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-west-2

    - name: Instalar AWS CLI e jq
      run: |
        sudo apt-get update
        sudo apt-get install -y jq
        curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
        unzip awscliv2.zip
        sudo ./aws/install
        aws --version

    - name: Verificar APK
      run: |
        if [ -f "app/android/flutter.apk" ]; then
          echo "‚úÖ APK encontrado! Tamanho: $(du -h app/android/flutter.apk | cut -f1)"
        else
          echo "‚ùå APK n√£o encontrado!"
          exit 1
        fi

    - name: Obter ARN do Google Pixel 9
      id: get-device
      run: |
        echo "üîç Buscando Google Pixel 9..."
        DEVICE_RESPONSE=$(aws devicefarm list-devices \
          --region us-west-2 \
          --query "devices[?name=='Google Pixel 9'].{arn:arn, name:name, os:os}" \
          --output json)
        
        echo "Devices encontrados: $DEVICE_RESPONSE"
        
        PIXEL9_ARN=$(echo $DEVICE_RESPONSE | jq -r '.[0].arn')
        PIXEL9_OS=$(echo $DEVICE_RESPONSE | jq -r '.[0].os')
        
        if [ -n "$PIXEL9_ARN" ] && [ "$PIXEL9_ARN" != "null" ]; then
          echo "‚úÖ Google Pixel 9 encontrado! OS: $PIXEL9_OS"
          echo "PIXEL9_ARN=$PIXEL9_ARN" >> $GITHUB_ENV
        else
          echo "‚ùå Google Pixel 9 n√£o encontrado"
          exit 1
        fi

    - name: Criar Device Pool para Google Pixel 9
      id: create-pool
      run: |
        echo "üèóÔ∏è Criando Device Pool customizado..."
        POOL_RESPONSE=$(aws devicefarm create-device-pool \
          --project-arn "arn:aws:devicefarm:us-west-2:593793055311:project:35f719fe-a34d-49e8-8984-a0c79d15efba" \
          --name "Google-Pixel-9-Only" \
          --description "Device pool exclusivo para Google Pixel 9" \
          --rules '[]' \
          --region us-west-2)
        
        POOL_ARN=$(echo $POOL_RESPONSE | jq -r '.devicePool.arn')
        
        if [ -n "$POOL_ARN" ] && [ "$POOL_ARN" != "null" ]; then
          echo "‚úÖ Device Pool criado: $POOL_ARN"
          echo "POOL_ARN=$POOL_ARN" >> $GITHUB_ENV
          
          # Adicionar Google Pixel 9 ao pool
          echo "üì± Adicionando Google Pixel 9 ao pool..."
          aws devicefarm update-device-pool \
            --arn $POOL_ARN \
            --name "Google-Pixel-9-Only" \
            --devices-to-add $PIXEL9_ARN \
            --region us-west-2
        else
          echo "‚ùå Falha ao criar Device Pool"
          exit 1
        fi

    - name: Upload APK para Device Farm
      id: upload-apk
      run: |
        TIMESTAMP=$(date +%Y%m%d%H%M%S)
        echo "üì§ Upload do APK..."
        
        UPLOAD_RESPONSE=$(aws devicefarm create-upload \
          --project-arn "arn:aws:devicefarm:us-west-2:593793055311:project:35f719fe-a34d-49e8-8984-a0c79d15efba" \
          --name "flutter-app-$TIMESTAMP.apk" \
          --type ANDROID_APP \
          --region us-west-2)
        
        UPLOAD_ARN=$(echo $UPLOAD_RESPONSE | jq -r '.upload.arn')
        UPLOAD_URL=$(echo $UPLOAD_RESPONSE | jq -r '.upload.url')
        
        echo "UPLOAD_ARN=$UPLOAD_ARN" >> $GITHUB_ENV
        curl -X PUT -T app/android/flutter.apk "$UPLOAD_URL"
        echo "‚úÖ Upload conclu√≠do!"

    - name: Aguardar processamento do APK
      id: process-apk
      run: |
        echo "‚è≥ Processando APK..."
        for i in {1..30}; do
          STATUS=$(aws devicefarm get-upload \
            --arn $UPLOAD_ARN \
            --region us-west-2 \
            --query 'upload.status' \
            --output text)
          
          echo "Status: $STATUS ($i/30)"
          
          if [ "$STATUS" == "SUCCEEDED" ]; then
            echo "‚úÖ APK processado!"
            break
          elif [ "$STATUS" == "FAILED" ]; then
            echo "‚ùå Falha no APK"
            exit 1
          fi
          sleep 10
        done

    - name: Executar teste no Google Pixel 9
      id: run-test
      run: |
        echo "üöÄ Executando no Google Pixel 9..."
        
        RUN_RESPONSE=$(aws devicefarm schedule-run \
          --project-arn "arn:aws:devicefarm:us-west-2:593793055311:project:35f719fe-a34d-49e8-8984-a0c79d15efba" \
          --app-arn $UPLOAD_ARN \
          --device-pool-arn $POOL_ARN \
          --name "Pixel9-Test-$(date +%Y%m%d%H%M%S)" \
          --test type=BUILTIN_FUZZ \
          --region us-west-2)
        
        RUN_ARN=$(echo $RUN_RESPONSE | jq -r '.run.arn')
        echo "RUN_ARN=$RUN_ARN" >> $GITHUB_ENV
        echo "‚úÖ Teste agendado no Google Pixel 9!"

    - name: Aguardar conclus√£o
      id: wait-completion
      run: |
        echo "‚è≥ Aguardando teste no Google Pixel 9..."
        for i in {1..60}; do
          STATUS=$(aws devicefarm get-run \
            --arn $RUN_ARN \
            --region us-west-2 \
            --query 'run.status' \
            --output text)
          
          echo "Status: $STATUS ($i/60)"
          
          if [ "$STATUS" == "COMPLETED" ]; then
            echo "üéâ Teste conclu√≠do!"
            break
          elif [ "$STATUS" == "ERRORED" ] || [ "$STATUS" == "STOPPED" ]; then
            echo "‚ùå Teste falhou"
            exit 1
          fi
          sleep 30
        done

    - name: Verificar resultados detalhados
      if: always()
      run: |
        echo "üìä Resultados do Google Pixel 9:"
        
        RUN_DETAILS=$(aws devicefarm get-run \
          --arn $RUN_ARN \
          --region us-west-2)
        
        # Informa√ß√µes b√°sicas
        echo "$RUN_DETAILS" | jq '.run | {device: .device.name, os: .device.os, status: .status, result: .result}'
        
        # Jobs espec√≠ficos
        echo "üîç Buscando jobs detalhados..."
        JOBS_RESPONSE=$(aws devicefarm list-jobs \
          --arn $RUN_ARN \
          --region us-west-2)
        
        echo "$JOBS_RESPONSE" | jq '.jobs[] | {arn: .arn, status: .status, device: .device.name}'
        
        # Se tiver Job ARN espec√≠fico, buscar detalhes
        if [ -n "${{ env.JOB_ARN }}" ]; then
          echo "üìã Detalhes do Job:"
          aws devicefarm get-job \
            --arn "${{ env.JOB_ARN }}" \
            --region us-west-2 \
            --query 'job.{name: .name, status: .status, device: .device.name, result: .result}' \
            --output table
        fi

    - name: Limpar Device Pool
      if: always()
      run: |
        echo "üßπ Limpando Device Pool customizado..."
        aws devicefarm delete-device-pool \
          --arn $POOL_ARN \
          --region us-west-2 \
          || echo "‚ö†Ô∏è N√£o foi poss√≠vel deletar o pool"
