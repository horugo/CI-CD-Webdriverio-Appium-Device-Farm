name: AWS Device Farm Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout do c√≥digo
      uses: actions/checkout@v4

    - name: Setup Node.js 24
      uses: actions/setup-node@v4
      with:
        node-version: '24'
        cache: 'npm'

    - name: Setup Java 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Instalar depend√™ncias
      run: npm ci

    - name: Configurar AWS
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-west-2  ‚Üê SUA REGI√ÉO

    - name: Instalar AWS CLI e jq
      run: |
        sudo apt-get update
        sudo apt-get install -y jq
        curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
        unzip awscliv2.zip
        sudo ./aws/install
        aws --version

    - name: Verificar APK
      run: |
        echo "üîç Verificando ambiente..."
        echo "‚úÖ Node: $(node --version)"
        echo "‚úÖ Java: $(java -version 2>&1 | head -1)"
        echo "‚úÖ AWS CLI: $(aws --version 2>&1)"
        
        if [ -f "app/android/flutter.apk" ]; then
          echo "‚úÖ APK encontrado! Tamanho: $(du -h app/android/flutter.apk | cut -f1)"
          ls -la app/android/flutter.apk
        else
          echo "‚ùå APK n√£o encontrado em app/android/flutter.apk"
          echo "üìÅ Procurando APKs..."
          find . -name "*.apk" | head -10
          exit 1
        fi

    - name: Upload APK para Device Farm
      run: |
        TIMESTAMP=$(date +%Y%m%d%H%M%S)
        echo "üì§ Iniciando upload do APK..."
        
        # Upload do APK
        UPLOAD_RESPONSE=$(aws devicefarm create-upload \
          --project-arn "arn:aws:devicefarm:us-west-2:593793055311:project:35f719fe-a34d-49e8-8984-a0c79d15efba" \
          --name "flutter-app-$TIMESTAMP.apk" \
          --type ANDROID_APP \
          --region us-west-2)
        
        echo "Upload Response: $UPLOAD_RESPONSE"
        
        # Extrair ARN do upload e URL
        UPLOAD_ARN=$(echo $UPLOAD_RESPONSE | jq -r '.upload.arn')
        UPLOAD_URL=$(echo $UPLOAD_RESPONSE | jq -r '.upload.url')
        
        echo "UPLOAD_ARN=$UPLOAD_ARN" >> $GITHUB_ENV
        echo "üì§ Fazendo upload do arquivo..."
        
        # Fazer upload do arquivo
        curl -X PUT -T app/android/flutter.apk -H "Content-Type: application/vnd.android.package-archive" "$UPLOAD_URL"
        
        echo "‚úÖ Upload conclu√≠do!"

    - name: Aguardar processamento do APK
      run: |
        echo "‚è≥ Aguardando processamento do APK..."
        for i in {1..30}; do
          STATUS=$(aws devicefarm get-upload \
            --arn $UPLOAD_ARN \
            --region us-west-2 \
            --query 'upload.status' \
            --output text)
          
          echo "Status do APK: $STATUS (tentativa $i/30)"
          
          case $STATUS in
            "SUCCEEDED")
              echo "üéâ APK processado com sucesso!"
              break
              ;;
            "FAILED")
              echo "‚ùå Falha no processamento do APK"
              # Obter detalhes do erro
              aws devicefarm get-upload --arn $UPLOAD_ARN --region us-west-2
              exit 1
              ;;
            "PROCESSING"|"INITIALIZED")
              sleep 10
              ;;
            *)
              echo "‚ö†Ô∏è Status desconhecido: $STATUS"
              sleep 10
              ;;
          esac
        done
        
        if [ "$STATUS" != "SUCCEEDED" ]; then
          echo "‚è∞ Timeout no processamento do APK"
          exit 1
        fi

    - name: Executar teste no Device Farm
      run: |
        echo "üöÄ Agendando execu√ß√£o no Device Farm..."
        
        # Obter device pool (usa o Top Devices padr√£o)
        DEVICE_POOL_ARN=$(aws devicefarm list-device-pools \
          --arn "arn:aws:devicefarm:us-west-2:593793055311:project:35f719fe-a34d-49e8-8984-a0c79d15efba" \
          --region us-west-2 \
          --query "devicePools[?name=='Top Devices'].arn" \
          --output text)
        
        if [ -z "$DEVICE_POOL_ARN" ]; then
          echo "‚ùå Device Pool 'Top Devices' n√£o encontrado"
          echo "üìã Listando todos device pools:"
          aws devicefarm list-device-pools \
            --arn "arn:aws:devicefarm:us-west-2:593793055311:project:35f719fe-a34d-49e8-8984-a0c79d15efba" \
            --region us-west-2
          exit 1
        fi
        
        echo "‚úÖ Device Pool: $DEVICE_POOL_ARN"
        
        # Agendar run de teste
        RUN_RESPONSE=$(aws devicefarm schedule-run \
          --project-arn "arn:aws:devicefarm:us-west-2:593793055311:project:35f719fe-a34d-49e8-8984-a0c79d15efba" \
          --app-arn $UPLOAD_ARN \
          --device-pool-arn $DEVICE_POOL_ARN \
          --name "Teste-GitHub-$(date +%Y%m%d%H%M%S)" \
          --test type=BUILTIN_FUZZ \
          --region us-west-2)
        
        RUN_ARN=$(echo $RUN_RESPONSE | jq -r '.run.arn')
        echo "RUN_ARN=$RUN_ARN" >> $GITHUB_ENV
        echo "‚úÖ Teste agendado! ARN: $RUN_ARN"

    - name: Aguardar conclus√£o do teste
      run: |
        echo "‚è≥ Aguardando conclus√£o do teste no Device Farm..."
        for i in {1..60}; do
          RUN_STATUS=$(aws devicefarm get-run \
            --arn $RUN_ARN \
            --region us-west-2 \
            --query 'run.status' \
            --output text)
          
          echo "Status do teste: $RUN_STATUS (aguardando $i/60)"
          
          case $RUN_STATUS in
            "COMPLETED")
              echo "üéâ Teste conclu√≠do com sucesso!"
              break
              ;;
            "ERRORED"|"STOPPED")
              echo "‚ùå Teste falhou: $RUN_STATUS"
              # Obter detalhes do erro
              aws devicefarm get-run --arn $RUN_ARN --region us-west-2
              exit 1
              ;;
            "PENDING"|"PROCESSING"|"SCHEDULING"|"RUNNING")
              sleep 30
              ;;
            *)
              echo "‚ö†Ô∏è Status desconhecido: $RUN_STATUS"
              sleep 30
              ;;
          esac
        done

    - name: Verificar resultados
      if: always()
      run: |
        echo "üìä Obtendo resultados do teste..."
        aws devicefarm get-run \
          --arn $RUN_ARN \
          --region us-west-2 \
          --query 'run.{name:name, status:status, result:result, deviceMinutes:deviceMinutes}' \
          --output table
        
        echo "üîó Acesse a console do AWS Device Farm para ver detalhes completos!"
