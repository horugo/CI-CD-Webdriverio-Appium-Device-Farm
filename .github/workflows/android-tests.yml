name: Android Automation Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout do cÃ³digo
      uses: actions/checkout@v4

    - name: Setup Node.js 24
      uses: actions/setup-node@v4
      with:
        node-version: '24'
        cache: 'npm'

    - name: Instalar dependÃªncias
      run: npm ci

    - name: Setup Java 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v2

    - name: Instalar Android 10 e emulador
      run: |
        $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "platforms;android-29" 
        $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "system-images;android-29;google_apis;x86_64"
        $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "emulator"

    - name: Criar AVD com Pixel 4
      run: |
        echo "no" | $ANDROID_HOME/cmdline-tools/latest/bin/avdmanager create avd \
          -n test \
          -k "system-images;android-29;google_apis;x86_64" \
          -d "pixel_4" \
          -f
        echo "âœ… AVD Pixel 4 criado com sucesso!"

    - name: Iniciar emulador com timeout
      run: |
        # Iniciar emulador em background
        $ANDROID_HOME/emulator/emulator \
          -avd test \
          -no-window \
          -no-audio \
          -no-snapshot \
          -gpu swiftshader_indirect \
          -memory 2048 \
          -accel auto &
        
        EMULATOR_PID=$!
        echo "EMULATOR_PID=$EMULATOR_PID" >> $GITHUB_ENV
        
        # Aguardar mÃ¡ximo 3 minutos com checks melhores
        timeout 180s bash -c '
          until adb shell getprop sys.boot_completed 2>/dev/null | grep -q "1"; do
            echo "â³ Aguardando emulador bootar..."
            sleep 10
          done
          echo "âœ… Emulador boot completo!"
        ' || echo "âš ï¸ Timeout - continuando mesmo sem boot completo"

    - name: Verificar estado do emulador
      run: |
        echo "ðŸ“± Verificando estado do emulador:"
        adb devices
        adb shell getprop ro.build.version.release || echo "âŒ NÃ£o conseguiu acessar propriedades"
        adb shell getprop sys.boot_completed || echo "âŒ Boot nÃ£o completado totalmente"
        adb shell input keyevent 82 || echo "âš ï¸ NÃ£o conseguiu enviar keyevent"

    - name: Configurar ambiente Android
      run: |
        # Desativar animaÃ§Ãµes para testes mais rÃ¡pidos
        adb shell settings put global window_animation_scale 0.0
        adb shell settings put global transition_animation_scale 0.0
        adb shell settings put global animator_duration_scale 0.0
        adb shell settings put secure show_ime_with_hard_keyboard 0
        echo "âœ… Ambiente Android configurado"

    - name: Instalar e iniciar Appium
      run: |
        npm install -g appium
        appium --log-level info --session-override --allow-insecure chromedriver_autodownload &
        sleep 15
        echo "âœ… Appium iniciado"

    - name: Verificar se app existe
      run: |
        if [ -f "app/android/flutter.apk" ]; then
          echo "âœ… App encontrado!"
          ls -la app/android/flutter.apk
          echo "Tamanho do APK: $(du -h app/android/flutter.apk | cut -f1)"
        else
          echo "âŒ App NÃƒO encontrado!"
          echo "Procurando APKs..."
          find . -name "*.apk" | head -10
          exit 1
        fi

    - name: Executar testes WebdriverIO
      run: npm run wdio
      timeout-minutes: 15
      env:
        CI: true
        NODE_ENV: ci

    - name: Parar emulador
      if: always()
      run: |
        echo "ðŸ›‘ Parando emulador..."
        kill -9 $EMULATOR_PID 2>/dev/null || true
        adb emu kill 2>/dev/null || true
        echo "âœ… Emulador parado"
