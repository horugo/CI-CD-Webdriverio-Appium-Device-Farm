name: Android Automation Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout do cÃ³digo
      uses: actions/checkout@v4

    - name: Setup Node.js 24
      uses: actions/setup-node@v4
      with:
        node-version: '24'
        cache: 'npm'

    - name: Instalar dependÃªncias
      run: npm ci

    - name: Setup Java 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v2

    - name: Verificar ambiente Android
      run: |
        echo "ðŸ“± Android Home: $ANDROID_HOME"
        echo "ðŸ“± Android SDK Root: $ANDROID_SDK_ROOT"
        ls -la $ANDROID_HOME

    - name: Instalar componentes Android necessÃ¡rios
      run: |
        # Aceitar licenÃ§as primeiro
        yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses
        
        # Instalar componentes especÃ­ficos
        $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "platform-tools"
        $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "platforms;android-33"
        $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "system-images;android-33;google_apis;x86_64"
        $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "emulator"

    - name: Listar AVDs disponÃ­veis
      run: |
        $ANDROID_HOME/cmdline-tools/latest/bin/avdmanager list avd

    - name: Criar AVD manualmente com configuraÃ§Ã£o explÃ­cita
      run: |
        # Criar diretÃ³rio AVD se nÃ£o existir
        mkdir -p $HOME/.android/avd
        
        # Criar AVD
        echo "no" | $ANDROID_HOME/cmdline-tools/latest/bin/avdmanager create avd \
          -n android33_avd \
          -k "system-images;android-33;google_apis;x86_64" \
          -d "pixel_4" \
          -f
        
        # Verificar se foi criado
        echo "ðŸ“± AVDs criados:"
        $ANDROID_HOME/cmdline-tools/latest/bin/avdmanager list avd
        
        # Listar arquivos do AVD
        echo "ðŸ“ ConteÃºdo do diretÃ³rio AVD:"
        ls -la $HOME/.android/avd/

    - name: Iniciar emulador
      run: |
        # Configurar variÃ¡veis de ambiente
        export ANDROID_AVD_HOME=$HOME/.android/avd
        export ANDROID_SDK_HOME=$HOME/.android
        
        echo "ðŸš€ Iniciando emulador..."
        $ANDROID_HOME/emulator/emulator \
          -avd android33_avd \
          -no-window \
          -no-audio \
          -no-snapshot \
          -gpu swiftshader_indirect \
          -memory 2048 \
          -netdelay none \
          -netspeed full &
        
        EMULATOR_PID=$!
        echo "EMULATOR_PID=$EMULATOR_PID" >> $GITHUB_ENV
        
        # Aguardar o emulador inicializar
        echo "â³ Aguardando emulador..."
        sleep 30
        
        # Tentar conectar
        adb devices
        adb wait-for-device
        
        echo "âœ… Emulador inicializado!"

    - name: Aguardar boot completo
      run: |
        echo "ðŸ”„ Aguardando boot completo..."
        # Aguardar atÃ© 2 minutos pelo boot
        for i in {1..24}; do
          if adb shell getprop sys.boot_completed 2>/dev/null | grep -q "1"; then
            echo "âœ… Boot completado!"
            break
          fi
          echo "â³ Aguardando boot... ($i/24)"
          sleep 5
        done
        
        # Verificar estado final
        adb shell getprop sys.boot_completed || echo "âš ï¸ Boot nÃ£o completou totalmente"

    - name: Configurar ambiente de teste
      run: |
        echo "âš™ï¸ Configurando ambiente..."
        adb shell settings put global window_animation_scale 0.0
        adb shell settings put global transition_animation_scale 0.0
        adb shell settings put global animator_duration_scale 0.0
        adb shell settings put secure show_ime_with_hard_keyboard 0
        echo "âœ… Ambiente configurado"

    - name: Instalar e iniciar Appium
      run: |
        npm install -g appium
        appium --log-level info --session-override --allow-insecure chromedriver_autodownload &
        sleep 10
        echo "âœ… Appium iniciado"

    - name: Verificar se app existe
      run: |
        if [ -f "app/android/flutter.apk" ]; then
          echo "âœ… App encontrado: app/android/flutter.apk"
          ls -la app/android/flutter.apk
        else
          echo "âŒ App NÃƒO encontrado em app/android/flutter.apk"
          echo "ðŸ“ Estrutura do projeto:"
          find . -name "*.apk" -o -name "*.txt" -o -name "*.json" | head -20
          exit 1
        fi

    - name: Executar testes WebdriverIO
      run: npm run wdio
      timeout-minutes: 10
      env:
        CI: true

    - name: Parar emulador
      if: always()
      run: |
        echo "ðŸ›‘ Parando emulador..."
        kill -9 $EMULATOR_PID 2>/dev/null || true
        adb emu kill 2>/dev/null || true
        echo "âœ… Cleanup completo"
