name: Android Automation Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout do cÃ³digo
      uses: actions/checkout@v4

    - name: Setup Node.js 24
      uses: actions/setup-node@v4
      with:
        node-version: '24'
        cache: 'npm'

    - name: Instalar dependÃªncias
      run: npm ci

    - name: Setup Java 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v2

    - name: Instalar Android 33 (mais estÃ¡vel)
      run: |
        yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses
        $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "platforms;android-33"
        $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "system-images;android-33;google_apis;x86_64"
        $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "emulator" "platform-tools"

    - name: Criar AVD de forma confiÃ¡vel
      run: |
        # Criar AVD sem device especÃ­fico (mais confiÃ¡vel)
        echo "no" | $ANDROID_HOME/cmdline-tools/latest/bin/avdmanager create avd \
          -n test_avd \
          -k "system-images;android-33;google_apis;x86_64" \
          -f
        
        # Verificar se foi criado
        echo "ðŸ“± AVDs disponÃ­veis:"
        $ANDROID_HOME/cmdline-tools/latest/bin/avdmanager list avd

    - name: Iniciar emulador de forma robusta
      run: |
        # Configurar environment variables corretamente
        export ANDROID_AVD_HOME=$HOME/.android/avd
        export ANDROID_SDK_HOME=$HOME/.android
        
        echo "ðŸš€ Iniciando emulador..."
        nohup $ANDROID_HOME/emulator/emulator \
          -avd test_avd \
          -no-window \
          -no-audio \
          -no-snapshot \
          -gpu swiftshader_indirect \
          -memory 2048 \
          -netdelay none \
          -netspeed full > emulator.log 2>&1 &
        
        EMULATOR_PID=$!
        echo "EMULATOR_PID=$EMULATOR_PID" >> $GITHUB_ENV
        
        # Aguardar inicializaÃ§Ã£o
        echo "â³ Aguardando emulador inicializar..."
        sleep 60
        
        # Verificar se estÃ¡ rodando
        if ps -p $EMULATOR_PID > /dev/null; then
          echo "âœ… Processo do emulador estÃ¡ rodando (PID: $EMULATOR_PID)"
        else
          echo "âŒ Emulador nÃ£o estÃ¡ rodando"
          echo "ðŸ“„ Log do emulador:"
          cat emulator.log || echo "Sem log disponÃ­vel"
          exit 1
        fi

    - name: Aguardar e verificar emulador
      run: |
        echo "ðŸ” Verificando estado do emulador..."
        
        # Tentar conectar via ADB
        adb devices
        adb wait-for-device
        
        # Aguardar boot com timeout
        echo "ðŸ”„ Aguardando boot completo (mÃ¡x 3 minutos)..."
        for i in {1..36}; do
          if adb shell getprop sys.boot_completed 2>/dev/null | grep -q "1"; then
            echo "âœ… Boot completado apÃ³s ${i}0 segundos!"
            break
          fi
          echo "â³ Aguardando... ($i/36)"
          sleep 10
        done
        
        # Verificar estado final
        echo "ðŸ“Š Estado final:"
        adb shell getprop sys.boot_completed || echo "âŒ Boot nÃ£o completou"
        adb shell getprop ro.build.version.release || echo "âŒ NÃ£o conseguiu acessar propriedades"

    - name: Configurar ambiente
      run: |
        echo "âš™ï¸ Configurando ambiente Android..."
        adb shell settings put global window_animation_scale 0.0
        adb shell settings put global transition_animation_scale 0.0
        adb shell settings put global animator_duration_scale 0.0
        echo "âœ… Ambiente configurado"

    - name: Instalar e iniciar Appium
      run: |
        npm install -g appium
        appium --log-level info --session-override --allow-insecure chromedriver_autodownload &
        sleep 20
        echo "âœ… Appium iniciado"

    - name: Verificar se app existe
      run: |
        if [ -f "app/android/flutter.apk" ]; then
          echo "âœ… App encontrado: app/android/flutter.apk"
          echo "ðŸ“ Tamanho: $(du -h app/android/flutter.apk | cut -f1)"
        else
          echo "âŒ App NÃƒO encontrado!"
          echo "ðŸ“ Estrutura do projeto:"
          find . -type f -name "*.apk" -o -name "wdio.conf.*" -o -name "package.json" | head -20
          exit 1
        fi

    - name: Executar testes WebdriverIO
      run: npm run wdio
      timeout-minutes: 15
      env:
        CI: true

    - name: Parar emulador
      if: always()
      run: |
        echo "ðŸ›‘ Parando emulador..."
        kill -9 $EMULATOR_PID 2>/dev/null || true
        adb emu kill 2>/dev/null || true
        pkill -f emulator 2>/dev/null || true
        echo "âœ… Cleanup completo"
