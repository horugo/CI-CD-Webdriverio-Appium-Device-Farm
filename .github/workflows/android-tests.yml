name: Android Automation Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout do c√≥digo
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '24'
        cache: 'npm'

    - name: Instalar depend√™ncias
      run: npm ci

    - name: Setup Java
      uses: actions/setup-java@v3
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v2

    - name: Listar devices dispon√≠veis
      run: |
        $ANDROID_HOME/cmdline-tools/latest/bin/avdmanager list device

    - name: Criar e iniciar emulador Android 10
      uses: reactivecircus/android-emulator-runner@v2
      with:
        api-level: 29
        target: google_apis
        arch: x86_64
        # REMOVA o profile ou use um que existe
        # profile: Pixel 4  # ‚õî REMOVER ESTA LINHA
        force-avd-creation: true
        emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none
        disable-animations: true
        script: |
          echo "üì± Emulador est√° pronto!"
          adb devices
          adb shell getprop ro.build.version.release

    - name: Configurar anima√ß√µes desligadas
      run: |
        adb shell settings put global window_animation_scale 0.0
        adb shell settings put global transition_animation_scale 0.0
        adb shell settings put global animator_duration_scale 0.0

    - name: Instalar e iniciar Appium
      run: |
        npm install -g appium
        appium --log-level info --session-override --allow-insecure chromedriver_autodownload &
        sleep 15

    - name: Verificar se app existe
      run: |
        if [ -f "app/android/flutter.apk" ]; then
          echo "‚úÖ App encontrado!"
          ls -la app/android/flutter.apk
        else
          echo "‚ùå App N√ÉO encontrado!"
          find . -name "*.apk" || echo "Nenhum APK encontrado"
          exit 1
        fi

    - name: Executar testes WebdriverIO
      run: npm run wdio
      timeout-minutes: 30
