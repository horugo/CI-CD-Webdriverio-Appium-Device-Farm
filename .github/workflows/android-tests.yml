name: Android Automation Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout do c√≥digo
      uses: actions/checkout@v4

    - name: Setup Node.js 24
      uses: actions/setup-node@v4
      with:
        node-version: '24'
        cache: 'npm'

    - name: Instalar depend√™ncias
      run: npm ci

    - name: Setup Java 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Iniciar Emulador Android com Action Confi√°vel
      uses: actions/emulator-tool@v1
      with:
        api-level: 33
        target: google_apis
        arch: x86_64
        profile: Pixel 4
        avd-name: test-avd
        force-avd-creation: true
        emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none -memory 2048 -accel auto
        disable-animations: true
        script: |
          echo "üì± Emulador est√° rodando!"
          adb devices
          adb shell getprop ro.build.version.release
          adb shell getprop sys.boot_completed

    - name: Configurar ambiente de teste
      run: |
        echo "‚öôÔ∏è Configurando ambiente..."
        adb shell settings put global window_animation_scale 0.0
        adb shell settings put global transition_animation_scale 0.0
        adb shell settings put global animator_duration_scale 0.0
        echo "‚úÖ Ambiente configurado"

    - name: Instalar e iniciar Appium
      run: |
        npm install -g appium
        appium --log-level info --session-override --allow-insecure chromedriver_autodownload &
        sleep 15
        echo "‚úÖ Appium iniciado"

    - name: Verificar se app existe
      run: |
        if [ -f "app/android/flutter.apk" ]; then
          echo "‚úÖ App encontrado: app/android/flutter.apk"
          ls -la app/android/flutter.apk
        else
          echo "‚ùå App N√ÉO encontrado em app/android/flutter.apk"
          echo "üìÅ Procurando APKs..."
          find . -name "*.apk" | head -10
          exit 1
        fi

    - name: Executar testes WebdriverIO
      run: npm run wdio
      timeout-minutes: 10
      env:
        CI: true
